mod chip8;
mod chip8_io;

use chip8::*;
use chip8_io::*;
use std::fs::File;
use std::{cell::RefCell, rc::Rc};

fn main() {
    let font: [u8; FONT_SIZE] = [
        0xF0, 0x90, 0x90, 0x90, 0xF0, // 0
        0x20, 0x60, 0x20, 0x20, 0x70, // 1
        0xF0, 0x10, 0xF0, 0x80, 0xF0, // 2
        0xF0, 0x10, 0xF0, 0x10, 0xF0, // 3
        0x90, 0x90, 0xF0, 0x10, 0x10, // 4
        0xF0, 0x80, 0xF0, 0x10, 0xF0, // 5
        0xF0, 0x80, 0xF0, 0x90, 0xF0, // 6
        0xF0, 0x10, 0x20, 0x40, 0x40, // 7
        0xF0, 0x90, 0xF0, 0x90, 0xF0, // 8
        0xF0, 0x90, 0xF0, 0x10, 0xF0, // 9
        0xF0, 0x90, 0xF0, 0x90, 0x90, // A
        0xE0, 0x90, 0xE0, 0x90, 0xE0, // B
        0xF0, 0x80, 0x80, 0x80, 0xF0, // C
        0xE0, 0x90, 0x90, 0x90, 0xE0, // D
        0xF0, 0x80, 0xF0, 0x80, 0xF0, // E
        0xF0, 0x80, 0xF0, 0x80, 0x80, // F
    ];
    let chip8_io = Rc::new(RefCell::new(Chip8IO::new(24)));
    let mut chip8_cpu = Chip8::new(&chip8_io, 0x000000FF, 0xFFFFFFFF);
    let mut rom_file = File::open("./roms/ibm_logo.ch8").unwrap();
    chip8_cpu.load_rom(&mut rom_file);
    chip8_cpu.load_font(&font[..], font.len());

    while chip8_io.borrow_mut().poll_input() {
        chip8_cpu.update_timers();

        for _ in 0..11 {
            chip8_cpu.run_cycle();
        }

        chip8_io.borrow_mut().render_frame();
    }
}
